global:
  scrape_interval:       5s
  evaluation_interval:   5s

# Based on https://github.com/waynedovey/openshift-prometheus
# and had to set `scheme: http` to make it work.

scrape_configs:

- job_name:              'kubernetes-apiservers'
  scheme:                http
  kubernetes_sd_configs:
  - role:                endpoints
    namespaces:
      names:
      - resorcerer

  relabel_configs:
  - action:              labelmap
    regex:               __meta_kubernetes_node_label_(.+)

- job_name:              'kubernetes-service-endpoints'
  scheme:                http
  kubernetes_sd_configs:
  - role:                endpoints
    namespaces:
      names:
      - resorcerer

  relabel_configs:
  - source_labels:       [__meta_kubernetes_service_annotation_prometheus_io_scrape]
    action:              keep
    regex:               true
  - source_labels:       [__meta_kubernetes_service_annotation_prometheus_io_scheme]
    action:              replace
    target_label:        __scheme__
    regex:               (https?)
  - source_labels:       [__meta_kubernetes_service_annotation_prometheus_io_path]
    action:              replace
    regex:               (.+)
    target_label:        __metrics_path__
  - source_labels:       [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
    action:              replace
    target_label:        __address__
    regex:               (.+)(?::\d+);(\d+)
    replacement:         $1:$2
  - action:              labelmap
    regex:               __meta_kubernetes_service_label_(.+)
  - source_labels:       [__meta_kubernetes_service_namespace]
    action:              replace
    target_label:        kubernetes_namespace
  - source_labels:       [__meta_kubernetes_service_name]
    action:              replace
    target_label:        kubernetes_name


- job_name:              'kubernetes-pods'
  scheme:                http
  kubernetes_sd_configs:
  - role:                pod
    namespaces:
      names:
      - resorcerer

  relabel_configs:
  - source_labels:       [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    action:              keep
    regex:               true
  - source_labels:       [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
    action:              replace
    target_label:        __scheme__
    regex:               (https?)
  - source_labels:       [__meta_kubernetes_pod_annotation_prometheus_io_path]
    action:              replace
    target_label:        __metrics_path__
    regex:               (.+)
  - source_labels:       [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
    action:              replace
    regex:               (.+):(?:\d+);(\d+)
    replacement:         ${1}:${2}
    target_label:        __address__
  - action:              labelmap
    regex:               __meta_kubernetes_pod_label_(.+)
